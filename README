# Initial Setup

Follow these steps in order to deploy from scratch.

## Secrets

Generate new secrets:

    ./generate-secret.sh > secrets/keycloak_admin_password.txt
    ./generate-secret.sh > secrets/keycloak_pg_password.txt
    ./generate-secret.sh > secrets/terraform_postgres_backend_password.txt

## Deployment

    ./build-images.sh && ./deploy-stacks.sh

## Keycloak

- Visit `http://localhost:8080` and log into Keycloak using the credentials
  `admin` and the password in `secrets/keycloak_admin_password.txt`
- Create a new Client in the `master` realm. Name it `terraform` - set the
  client ID to `terraform` as well. Tick "Client authentication", and untick all
  Authentication flow boxes except for "Service account roles", which should be
  ticked.
- Assign the new client the `create-realm` and `admin` Service account roles.
- Copy the client secret from the Credentials panel. Create a new `.env` file at
  `terraform/.env` with the following values, replacing the client secret as
  appropriate:

```
export PGUSER=terraform
export PGPASSWORD=$(cat ../secrets/terraform_postgres_backend_password.txt)
export PGSSLMODE=disable
export KEYCLOAK_CLIENT_ID=terraform
# This is pasted directly here because it is created by Keycloak rather than being managed by us.
export KEYCLOAK_CLIENT_SECRET="{{CLIENT SECRET GOES HERE}}"
export KEYCLOAK_URL=http://localhost:8080
```

- Execute `tofu apply` inside the terraform folder.
